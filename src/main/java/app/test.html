<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <div id = "application-content">

    </div>
</body>
<script>
        const ws = new WebSocket('ws://localhost:8080/websocket');
        const bindings = {};

        ws.onopen = () => { ws.send("{'type':'getVM','id':'app.UserRegistrationViewModel-0'}"); };
        ws.onmessage = (event) => {
            // We parse the data as json:
            const data = JSON.parse(event.data);
            loadVM(data);
        };

        function loadVM(data) {
            // Now let's check the type: either a view model or a property change...
            if (data.type === 'viewModel') {
                // We have a view model, so we can set it as the current view model:
                viewModel = data.viewModel;
                vmId = data.vmId;
                console.log("Received view model: " + JSON.stringify(viewModel));
                loadViewFor(
                    viewModel,
                    (propName, value) => {
                        ws.send(
                            "{'type':'act', 'vmId':'"+vmId+"', 'propName':'"+propName+"', 'value':'"+value+"'}"
                        );
                    },
                    (propName, action) => {
                        bindings[vmId+":"+propName] = action;
                    }
                );
            } else if ( data.type === 'show' ) {
                // We look up the binding for the property change:
                const binding = bindings[data.vmId+":"+data.propName];
                // If we have a binding, we call it with the new value:
                if ( binding )
                    binding(data.value);
            }
            console.log('From server' + data);
        }

        function loadViewFor(
            viewModelJson,
            vmSet,
            vmGet
        ) {
            // We turn the view model json into a pretty string
            var viewModelPrettyString = JSON.stringify(viewModelJson, null, 4);
            console.log("loadView... "+viewModelPrettyString);
            // Now let's load the view model into the view
            var applicationContent = document.getElementById("application-content");
            applicationContent.innerHTML = viewModelPrettyString;

            //vmSet("{'type':'act', 'action':'...'}");
            //vmGet();
            //vm.send('username', currentText)
            //vm.receive('username', newText =>usernameInput.val = newText)
            //vm.receive('feedback', newText =>feedbackDiv.text = newText)
            //vm.receive('feedbackColor', newColor =>feedbackDiv.color = newColor)
        }

    </script>
</html>