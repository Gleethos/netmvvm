<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <div id = "application-content">

    </div>
</body>
<script>
        const EVENT_TYPE = "EventType";
        const EVENT_PAYLOAD = "EventPayload";

        // Event Type Values:
        const SET_PROP = "act";
        const RETURN_PROP = "show";
        const GET_VM = "getVM";
        const RETURN_GET_VM = "viewModel";

        // View model properties:
        const VM_ID = "vmId";

        // Property properties:
        const PROP_NAME = "propName";
        const PROP_VALUE = "value";
        const PROP_TYPE = "type";
        const PROP_TYPE_NAME = "name";
        const PROP_TYPE_STATES = "states";

        const ws = new WebSocket('ws://localhost:8080/websocket');
        const bindings = {};

        ws.onopen = () => { ws.send("{'"+EVENT_TYPE+"':'"+GET_VM+"','"+VM_ID+"':'app.UserRegistrationViewModel-0'}"); };
        ws.onmessage = (event) => {
            // We parse the data as json:
            console.log("Received from server: " + event.data);
            const data = JSON.parse(event.data);
            loadVM(data);
        };

        function loadVM(data) {
            console.log('From server' + JSON.stringify(data));
            // Now let's check the EventType: either a view model or a property change...
            if (data[EVENT_TYPE] === RETURN_GET_VM) {
                // We have a view model, so we can set it as the current view model:
                const viewModel = data.viewModel;
                const vmId = data.vmId;
                console.log("Received view model: " + JSON.stringify(viewModel));
                loadViewFor(
                    viewModel,
                    (propName, value) => {
                        ws.send(
                            "{" +
                                "'"+EVENT_TYPE+"':'"+SET_PROP+"', " +
                                "'"+VM_ID+"':'"+vmId+"', " +
                                "'"+PROP_NAME+"':'"+propName+"', " +
                                "'"+PROP_VALUE+"':'"+value+"'" +
                            "}"
                        );
                    },
                    (propName, action) => {
                        bindings[vmId+":"+propName] = action;
                    }
                );
            } else if ( data[EVENT_TYPE] === RETURN_PROP ) {
                // We look up the binding for the property change:
                const binding = bindings[data[VM_ID]+":"+data[PROP_NAME]];
                // If we have a binding, we call it with the new value:
                if ( binding )
                    binding(data.value);
            }
        }

        function loadViewFor(
            viewModelJson,
            vmSet,
            vmGet
        ) {
            // We turn the view model json into a pretty string
            const viewModelPrettyString = JSON.stringify(viewModelJson, null, 4);
            console.log("loadView... "+viewModelPrettyString);
            // Now let's load the view model into the view
            const applicationContent = document.getElementById("application-content");

            // We attach a simple username password form with a terms of service checkbox
            const username = document.createElement("input");
            username.type = "text";
            username.placeholder = "Username";
            username.value = viewModelJson.username.value;
            username.onchange = (event) => { vmSet("username", event.target.value); };
            vmGet('username', txt => { username.value = txt; });
            applicationContent.appendChild(username);

            const password = document.createElement("input");
            password.type = "password";
            password.placeholder = "Password";
            password.value = viewModelJson.password.value;
            password.onchange = (event) => { vmSet("password", event.target.value); };
            vmGet('password', txt => { password.value = txt; });
            applicationContent.appendChild(password);
            // break:
            applicationContent.appendChild(document.createElement("br"));

            const termsOfService = document.createElement("input");
            termsOfService.type = "checkbox";
            termsOfService.checked = viewModelJson.termsAccepted.value;
            termsOfService.onchange = (event) => { vmSet("termsAccepted", event.target.checked); };
            vmGet('termsOfService', txt => { termsOfService.checked = txt; });
            applicationContent.appendChild(termsOfService);

            const termsOfServiceLabel = document.createElement("label");
            termsOfServiceLabel.innerHTML = "I agree to the terms of service";
            applicationContent.appendChild(termsOfServiceLabel);

            // break:
            applicationContent.appendChild(document.createElement("br"));
            applicationContent.appendChild(document.createElement("br"));

            const feedback = document.createElement("div");
            // We replace \n with br tags
            feedback.innerHTML = viewModelJson.feedback.value.replace(/\\n/g, "<br>");
            vmGet('feedback', txt => { feedback.innerHTML = txt.replace(/\n/g, "<br>"); });
            applicationContent.appendChild(feedback);
        }

    </script>
</html>